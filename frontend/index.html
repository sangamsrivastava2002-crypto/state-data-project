<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Search Data</title>

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: #ffffff;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      padding: 40px;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
    }

    select, input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      margin-top: 30px;
      width: 100%;
      padding: 14px;
      font-size: 18px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #45a049;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
    }

    tr:nth-child(even) {
      background-color: #fafafa;
    }

    .table-wrapper {
      max-height: 400px;
      overflow: auto;
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .info {
      margin-top: 20px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>

<body>
<div class="container">
  <h2>üîç Search Registry Data</h2>

  <!-- Table -->
  <label>Select Dataset:</label>
  <select id="table">
    <option value="">Select dataset</option>
  </select>

  <!-- Field -->
  <label>Search By:</label>
  <select id="field">
    <option value="">Select field</option>
    <option value="school_code">School Code</option>
    <option value="employee_code">Employee Code</option>
  </select>

  <!-- Value -->
  <label>Enter Code:</label>
  <input id="value" placeholder="Enter value">

  <button onclick="search()">Search</button>

  <div class="info" id="info"></div>
  <div id="result"></div>
</div>

<script>
const BACKEND = "https://state-data-project-1.onrender.com";

// Load datasets
window.onload = () => {
  fetch(`${BACKEND}/datasets`)
    .then(r => r.json())
    .then(data => {
      const select = document.getElementById("table");
      data.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.table;
        opt.textContent = `${d.table} (${d.type}, ${d.rows} rows)`;
        select.appendChild(opt);
      });
    });
};

function search() {
  const table = document.getElementById("table").value;
  const field = document.getElementById("field").value;
  const value = document.getElementById("value").value.trim();
  const info = document.getElementById("info");
  const result = document.getElementById("result");

  if (!table || !field || !value) {
    alert("Select dataset, field, and enter value");
    return;
  }

  info.innerText = "Searching...";
  result.innerHTML = "";

  const url =
    `${BACKEND}/search?table=${encodeURIComponent(table)}&field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`;

  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (!data.rows || data.rows.length === 0) {
        info.innerText = "Code not found";
        return;
      }

      info.innerText = `Records found: ${data.rows.length}`;

      const cols = Object.keys(data.rows[0]);
      let html = `<div class="table-wrapper"><table><thead><tr>`;

      cols.forEach(c => html += `<th>${c}</th>`);
      html += `</tr></thead><tbody>`;

      data.rows.forEach(row => {
        html += "<tr>";
        cols.forEach(c => html += `<td>${row[c] ?? ""}</td>`);
        html += "</tr>";
      });

      html += `</tbody></table></div>`;
      result.innerHTML = html;
    })
    .catch(() => {
      info.innerText = "Error searching data";
    });
}
</script>
</body>
</html>
